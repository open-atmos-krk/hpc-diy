---
- hosts: localhost
  connection: local
  become: true
  vars:
    external_iface: "enx3c18a0092635"
    dhcp_start:     "192.168.0.10"
    dhcp_end:       "192.168.0.50"
    dhcp_iface:     "eth0"
    dhcp_iface_ip:  "192.168.0.1"
    dhcp_mask:      "255.255.255.0"
    dhcp_mask_cidr: "24"
    dhcp_lease:     "24h"
    dhcp_domain:    "bowie.fis.agh.edu.pl"
    upstream_dns:
      - "1.1.1.1"
      - "8.8.8.8"

  tasks:
    - name: Bring up eth0 and assign static IP
      ansible.builtin.shell: |
        ip addr flush dev {{ dhcp_iface }} || true
        ip addr add {{ dhcp_iface_ip }}/24 dev {{ dhcp_iface }}
        ip link set {{ dhcp_iface }} up
      become: true

    - name: Write netplan config
      ansible.builtin.copy:
        dest: /etc/netplan/99-ansible.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              {{ dhcp_iface }}:
                dhcp4: false
                addresses: [{{ dhcp_iface_ip }}/{{ dhcp_mask_cidr }}]
      notify: Apply netplan
      
    - name: Install dnsmasq package
      ansible.builtin.apt:
        name: dnsmasq
        state: present
        update_cache: yes

    - name: Stop and disable systemd-resolved (if running) â€” avoid port 53 conflicts
      ansible.builtin.systemd:
        name: systemd-resolved
        enabled: false
        state: stopped
      ignore_errors: yes

    - name: Remove /etc/resolv.conf symlink (if any)
      ansible.builtin.file:
        path: /etc/resolv.conf
        state: absent
        force: true
      ignore_errors: yes

    - name: Write new /etc/resolv.conf (so dnsmasq has upstream DNS)
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 127.0.0.1

    - name: Deploy dnsmasq.conf
      ansible.builtin.copy:
        dest: /etc/dnsmasq.conf
        content: |
          domain-needed
          bogus-priv
          interface={{ dhcp_iface }}
          dhcp-range={{ dhcp_start }},{{ dhcp_end }},{{ dhcp_mask }},{{ dhcp_lease }}
          dhcp-option=option:router,{{ dhcp_iface_ip }}
          domain={{ dhcp_domain }}
          conf-dir=/etc/dnsmasq.d
          expand-hosts
          no-resolv
          {% for dns in upstream_dns %}
          server={{ dns }}
          {% endfor %}
          bind-dynamic
      notify: Restart dnsmasq

    - name: Enable IPv4 forwarding (routing) in kernel
      become: true
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        sysctl_set: yes
        reload: yes

    - name: Masquerade outbound traffic on external interface
      become: true
      ansible.builtin.iptables:
        table: nat
        chain: POSTROUTING
        out_interface: "{{ external_iface }}"
        jump: MASQUERADE

    - name: Ensure dnsmasq is enabled and started
      ansible.builtin.service:
        name: dnsmasq
        enabled: true
        state: started

  handlers:
    - name: Restart dnsmasq
      ansible.builtin.service:
        name: dnsmasq
        state: restarted
  
    - name: Apply netplan
      ansible.builtin.command: netplan apply
